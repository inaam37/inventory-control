generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id               String          @id @default(uuid())
  name             String
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt
  locations        Location[]
  users            User[]
  vendors          Vendor[]
  items            Item[]
  recipes          Recipe[]
  purchaseOrders   PurchaseOrder[]
  notifications    Notification[]
}

model Location {
  id             String       @id @default(uuid())
  organizationId String
  name           String
  timezone       String       @default("UTC")
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])
  items          Item[]
}

model User {
  id             String       @id @default(uuid())
  organizationId String
  fullName       String
  email          String       @unique
  role           UserRole     @default(MANAGER)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])
}

enum UserRole {
  ADMIN
  MANAGER
  STAFF
  VIEWER
}

model Vendor {
  id             String          @id @default(uuid())
  organizationId String
  name           String
  contactName    String?
  phone          String?
  email          String?
  address        String?
  deliverySchedule String?
  paymentTerms   String?
  reliabilityScore Float @default(0)
  ratingCount    Int    @default(0)
  notes          String?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  organization   Organization    @relation(fields: [organizationId], references: [id])
  items          Item[]
  priceHistory   PriceHistory[]
  purchaseOrders PurchaseOrder[]
}

model Item {
  id             String             @id @default(uuid())
  organizationId String
  vendorId       String?
  locationId     String?
  name           String
  category       String
  unit           String
  sku            String?
  onHand         Float    @default(0)
  parLevel       Float    @default(0)
  reorderPoint   Float    @default(0)
  costPerUnit    Float    @default(0)
  leadTimeDays   Int      @default(0)
  usagePerDay    Float    @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id])
  vendor         Vendor?  @relation(fields: [vendorId], references: [id])
  location       Location? @relation(fields: [locationId], references: [id])
  recipeLines    RecipeIngredient[]
  usageLogs      UsageLog[]
  salesLines     SalesIngredient[]
  priceHistory   PriceHistory[]
  purchaseOrderItems PurchaseOrderItem[]

  @@index([organizationId, locationId])
}


model Recipe {
  id             String             @id @default(uuid())
  organizationId String
  name           String
  yield          Int                @default(1)
  menuPrice      Float              @default(0)
  notes          String?
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  organization   Organization       @relation(fields: [organizationId], references: [id])
  ingredients    RecipeIngredient[]
  sales          SalesLog[]
}

model RecipeIngredient {
  id        String @id @default(uuid())
  recipeId  String
  itemId    String
  quantity  Float
  recipe    Recipe @relation(fields: [recipeId], references: [id])
  item      Item   @relation(fields: [itemId], references: [id])
}

model SalesLog {
  id         String            @id @default(uuid())
  recipeId   String
  servings   Int
  soldDate   DateTime
  createdAt  DateTime          @default(now())
  recipe     Recipe            @relation(fields: [recipeId], references: [id])
  salesLines SalesIngredient[]
}

model SalesIngredient {
  id         String   @id @default(uuid())
  salesLogId String
  itemId     String
  quantity   Float
  salesLog   SalesLog @relation(fields: [salesLogId], references: [id])
  item       Item     @relation(fields: [itemId], references: [id])
}

model UsageLog {
  id          String   @id @default(uuid())
  itemId       String
  usedQty      Float    @default(0)
  wasteQty     Float    @default(0)
  wasteReason  String?
  usedDate     DateTime
  createdAt    DateTime @default(now())
  item         Item     @relation(fields: [itemId], references: [id])
}

model PriceHistory {
  id            String   @id @default(uuid())
  itemId         String
  vendorId       String
  amount         Float
  effectiveDate  DateTime
  notes          String?
  createdAt      DateTime @default(now())
  item           Item     @relation(fields: [itemId], references: [id])
  vendor         Vendor   @relation(fields: [vendorId], references: [id])
}

model PurchaseOrder {
  id                   String                @id @default(uuid())
  organizationId       String
  vendorId             String
  status               PurchaseOrderStatus   @default(PENDING)
  totalCost            Float                 @default(0)
  expectedDeliveryDate DateTime?
  approvalStatus       ApprovalStatus        @default(APPROVED)
  approvalThreshold    Float                 @default(0)
  approvedAt           DateTime?
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  organization         Organization          @relation(fields: [organizationId], references: [id])
  vendor               Vendor                @relation(fields: [vendorId], references: [id])
  items                PurchaseOrderItem[]
}

enum PurchaseOrderStatus {
  PENDING
  PARTIAL
  DELIVERED
  CANCELLED
}

enum ApprovalStatus {
  PENDING_APPROVAL
  APPROVED
  REJECTED
}

model PurchaseOrderItem {
  id              String        @id @default(uuid())
  purchaseOrderId String
  itemId          String
  quantity        Float
  unitCost        Float
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id])
  item            Item          @relation(fields: [itemId], references: [id])
}

model Notification {
  id             String       @id @default(uuid())
  organizationId String
  type           String
  message        String
  createdAt      DateTime     @default(now())
  readAt         DateTime?
  organization   Organization @relation(fields: [organizationId], references: [id])
}

